<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PhishGuardian Portal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0f1115; --card:#171a21; --muted:#a9b1bd; --text:#e8edf2; --accent:#62d2ff; --ok:#1abc9c; --warn:#f39c12; --bad:#e74c3c; }
    * { box-sizing:border-box; }
    body { margin:0; font: 15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; background:var(--bg); color:var(--text); }
    header { display:flex; align-items:center; justify-content:space-between; padding:18px 22px; border-bottom:1px solid #232838; position:sticky; top:0; background:var(--bg); z-index:10;}
    .title { font-weight:700; letter-spacing:.2px; }
    main { padding:22px; max-width:1100px; margin:0 auto; }
    .card { background:var(--card); border:1px solid #22283a; border-radius:14px; padding:16px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:14px; }
    .btn { background:#1f2535; border:1px solid #2a3147; color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer; transition:.15s; }
    .btn:hover { filter:brightness(1.15); }
    .btn.primary { background:#183447; border-color:#1f4a64; color:#e8f7ff; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#21283a; font-size:12px; border:1px solid #2a3147; color:#a7b3c7; }
    input[type="text"]{ background:#121621; border:1px solid #22283a; color:var(--text); outline:none; border-radius:10px; padding:8px 10px; width:280px; }
    table { width:100%; border-collapse:collapse; }
    th,td { text-align:left; padding:8px 10px; border-bottom:1px solid #21283a; vertical-align:top; }
    th { color:#b9c3d6; font-weight:600; position:sticky; top:66px; background:var(--card); }
    .tag { padding:2px 8px; border-radius:999px; font-size:12px; display:inline-block; }
    .tag.clean { background:#102919; color:#7ef0b9; border:1px solid #17472e; }
    .tag.review { background:#2a250e; color:#ffd37a; border:1px solid #4b3b0e; }
    .tag.phish { background:#3a1212; color:#ff9f9f; border:1px solid #5c1b1b; }
    .muted { color:var(--muted); }
    .right { margin-left:auto; }
  </style>
</head>
<body>
  <header>
    <div class="title">PhishGuardian Portal <span class="pill" id="envTag">Live</span></div>
    <div class="row">
      <span class="muted" id="who">Signed out</span>
      <button class="btn" id="btnGoogle">Google Sign in</button>
      <button class="btn" id="btnEmail">Email/Password</button>
      <button class="btn" id="btnOut" style="display:none;">Sign out</button>
    </div>
  </header>

  <main>
    <div class="card">
      <div class="row">
        <button class="btn primary" id="btnRefresh">Refresh</button>
        <select class="btn" id="selVerdict">
          <option value="">All</option>
          <option value="phish">Phish</option>
          <option value="review">Review</option>
          <option value="clean">Clean</option>
        </select>
        <input type="text" id="q" placeholder="Search subject/from" />
        <button class="btn" id="btnApply">Apply filters</button>
        <span class="right muted" id="rowCount">0 rows</span>
      </div>
      <div style="overflow:auto; max-height:70vh;">
        <table id="grid">
          <thead>
          <tr>
            <th style="width:150px">When</th>
            <th style="width:80px">Score</th>
            <th style="width:90px">Verdict</th>
            <th>Subject</th>
            <th style="width:250px">From</th>
            <th style="width:220px">Reasons</th>
          </tr>
          </thead>
          <tbody id="tbody"><tr><td class="muted" colspan="6">No data.</td></tr></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Firebase (modular CDN) -->
  <script type="module">
    import { initializeApp }   from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, GoogleAuthProvider, onAuthStateChanged,
             signInWithPopup, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence }
             from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    /* ---------------------------------------------------
       1) CONFIG — filled with your Firebase values
       --------------------------------------------------- */

    // A) Your Apps Script Web App /exec URL.
    // If left empty, the page will prompt you once and store it in localStorage.
    let APPS_SCRIPT_URL = ""; // <-- paste your /exec URL here if you want to skip the prompt

    // B) Your Firebase config (from Firebase Console → Project settings → Web app → "Config")
    const firebaseConfig = {
      apiKey: "AIzaSyDKkDurWj7_1f4CzaVXuqP1ah3sC-j5Q7Q",
      authDomain: "phishguardian-ddaef.firebaseapp.com",
      projectId: "phishguardian-ddaef",
      storageBucket: "phishguardian-ddaef.appspot.com",
      messagingSenderId: "272605743",
      appId: "1:272605743:web:9b5c422c492e8f200a1cda"
    };

    /* ---------------------------------------------------
       2) Firebase init + Auth (with token refresh)
       --------------------------------------------------- */
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    await setPersistence(auth, browserLocalPersistence);

    const $ = s => document.querySelector(s);
    const tbody = $("#tbody"), who = $("#who"), outBtn = $("#btnOut");
    const rowCount = $("#rowCount");

    // Persist and reuse the Apps Script URL
    const urlKey = 'PG_APPS_SCRIPT_URL';
    if (!APPS_SCRIPT_URL) {
      APPS_SCRIPT_URL = localStorage.getItem(urlKey) || "";
      if (!APPS_SCRIPT_URL) {
        const u = prompt("Paste your Apps Script Web App /exec URL:");
        if (u) {
          APPS_SCRIPT_URL = u.trim();
          localStorage.setItem(urlKey, APPS_SCRIPT_URL);
        }
      }
    }

    let currentUser = null;
    let currentToken = null;
    let cacheRows = [];

    onAuthStateChanged(auth, async (user) => {
      currentUser = user || null;
      if (!user) {
        who.textContent = "Signed out";
        outBtn.style.display = "none";
        cacheRows = [];
        paint(cacheRows);
        return;
      }
      who.textContent = user.email || "Signed in";
      outBtn.style.display = "inline-block";
      try {
        // force refresh to avoid "invalid-credential" stale tokens
        currentToken = await user.getIdToken(true);
      } catch (e) {
        alert(`Firebase token error: ${e.message}`);
      }
    });

    /* ---------------------------------------------------
       3) UI events
       --------------------------------------------------- */
    $("#btnGoogle").onclick = async () => {
      try { await signInWithPopup(auth, provider); }
      catch (e) {
        if (String(e.message).includes('unauthorized-domain')) {
          alert('Firebase: add this domain in Authentication → Settings → Authorized domains:\n\n' +
                window.location.hostname);
        } else {
          alert(`Google sign-in failed: ${e.message}`);
        }
      }
    };
    $("#btnEmail").onclick = async () => {
      const email = prompt("Email");
      if (!email) return;
      const pass = prompt("Password");
      if (!pass) return;
      try { await signInWithEmailAndPassword(auth, email, pass); }
      catch (e) { alert(`Email/Password sign-in failed: ${e.message}`); }
    };
    $("#btnOut").onclick = async () => { try { await signOut(auth); } catch (e) { alert(e.message); } };

    $("#btnRefresh").onclick = () => loadDetections();
    $("#btnApply").onclick = () => paint(cacheRows);

    /* ---------------------------------------------------
       4) Data loading from Apps Script (with ID token)
       --------------------------------------------------- */
    async function loadDetections() {
      if (!APPS_SCRIPT_URL || !APPS_SCRIPT_URL.startsWith('https://')) {
        alert('Set the Apps Script /exec URL (prompt will appear again if empty).');
        localStorage.removeItem(urlKey);
        return;
      }
      if (!currentUser) {
        alert('Sign in first (Google or Email/Password).');
        return;
      }
      try {
        currentToken = await currentUser.getIdToken(true);

        const res = await fetch(APPS_SCRIPT_URL + '?action=detections', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${currentToken}`,
            'Accept': 'application/json'
          },
          mode: 'cors',
          cache: 'no-store',
        });

        if (!res.ok) {
          const txt = await res.text();
          throw new Error(`API ${res.status}: ${txt}`);
        }
        const data = await res.json(); // expecting { rows: [...] }
        cacheRows = Array.isArray(data.rows) ? data.rows : [];
        paint(cacheRows);
      } catch (e) {
        const msg = String(e.message || e);
        if (msg.includes('CORS') || msg.includes('origin')) {
          alert('CORS blocked. In Apps Script → Script properties, set ALLOWED_ORIGINS to:\n\n' +
                `https://${window.location.hostname}\n\n` +
                'Then save and retry.');
        } else if (msg.includes('invalid-credential')) {
          alert('Your Firebase credential expired. Click Sign out, then sign in again.');
        } else {
          alert(`Load failed: ${msg}`);
        }
      }
    }

    /* ---------------------------------------------------
       5) Render table
       --------------------------------------------------- */
    function paint(rows) {
      const q = ($("#q").value || '').toLowerCase().trim();
      const v = ($("#selVerdict").value || '').toLowerCase();

      const filtered = rows.filter(r => {
        // Accept both object and array row formats
        const obj = Array.isArray(r) ? {
          ts: r[0], threadId: r[1], msgId: r[2], from: r[3], to: r[4], subject: r[5],
          score: r[6], verdict: r[7], reasons: r[8]
        } : r;

        const hay = `${obj.subject||''} ${obj.from||''}`.toLowerCase();
        const verdict = String(obj.verdict || '').toLowerCase();

        const okQ = !q || hay.includes(q);
        const okV = !v || verdict === v;
        return okQ && okV;
      });

      rowCount.textContent = `${filtered.length} row${filtered.length===1?'':'s'}`;

      if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td class="muted" colspan="6">No data.</td></tr>`;
        return;
      }

      const html = filtered.map(r => {
        const o = Array.isArray(r) ? {
          ts: r[0], threadId: r[1], msgId: r[2], from: r[3], to: r[4], subject: r[5],
          score: r[6], verdict: r[7], reasons: r[8]
        } : r;

        const t = o.ts ? new Date(o.ts) : null;
        const when = t ? t.toLocaleString() : '-';
        const score = (o.score ?? '').toString();
        const verdict = (o.verdict || '').toLowerCase();
        const tagClass = verdict === 'phish' ? 'phish' : verdict === 'review' ? 'review' : 'clean';

        return `<tr>
          <td>${when}</td>
          <td>${score}</td>
          <td><span class="tag ${tagClass}">${verdict || 'clean'}</span></td>
          <td>${escapeHtml(o.subject || '')}</td>
          <td>${escapeHtml(o.from || '')}</td>
          <td class="muted">${escapeHtml((o.reasons || '').toString().replace(/\|/g, ', '))}</td>
        </tr>`;
      }).join('');
      tbody.innerHTML = html;
    }

    const escapeHtml = s => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

    // Auto-load if already signed in
    window.addEventListener('load', () => {
      if (auth.currentUser) { $("#btnRefresh").click(); }
    });
  </script>
</body>
</html>

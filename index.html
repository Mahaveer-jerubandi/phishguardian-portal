<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PhishGuardian Portal</title>
  <style>
    :root{--b:#18181b;--fg:#111;--bg:#fafafa;--mut:#666}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg);margin:0}
    header{padding:20px 24px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;background:#fff;position:sticky;top:0}
    h1{font-size:20px;margin:0}
    main{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #eee;border-radius:16px;padding:16px 16px;margin:16px 0;box-shadow:0 2px 16px rgba(0,0,0,.04)}
    input,button,select{padding:10px 12px;border:1px solid #ddd;border-radius:10px;background:#fff}
    button{cursor:pointer}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid #f0f0f0;padding:10px;text-align:left;vertical-align:top}
    th{font-weight:600;background:#fafafa}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;color:#fff;font-weight:600;font-size:12px}
    .benign{background:#16a34a}.suspicious{background:#d97706}.phishing{background:#dc2626}
    .admin{background:#0ea5e9;color:#fff;padding:4px 8px;border-radius:6px;font-size:12px;margin-left:6px}
    .muted{color:#777}
    .right{margin-left:auto}
    canvas{max-width:100%;height:220px}
  </style>
  <!-- Firebase -->
   

  <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDKkDurWj7_1f4CzaVXuqP1ah3sC-j5Q7Q",
    authDomain: "phishguardian-ddaef.firebaseapp.com",
    projectId: "phishguardian-ddaef",
    storageBucket: "phishguardian-ddaef.firebasestorage.app",
    messagingSenderId: "272605743",
    appId: "1:272605743:web:9b5c422c492e8f200a1cda"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
</script>


  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
<header>
  <h1>PhishGuardian Portal <span id="role" class=""></span></h1>
  <div class="row">
    <span id="authStatus" class="muted">Signed out</span>
    <button onclick="googleSignIn()">Google Sign in</button>
    <button onclick="emailSignIn()">Email/Password</button>
    <button onclick="signOut()">Sign out</button>
  </div>
</header>

<main>
  <div class="card">
    <h2>Detections</h2>
    <div class="row">
      <button onclick="loadDetections()">Refresh</button>
      <select id="filterVerdict">
        <option value="">All</option>
        <option value="benign">Benign</option>
        <option value="suspicious">Suspicious</option>
        <option value="phishing">Phishing</option>
      </select>
      <input id="filterText" placeholder="Search subject/from">
      <button onclick="applyFilters()">Apply filters</button>
      <span class="right muted" id="rowCount"></span>
    </div>
    <div id="detections"></div>
  </div>

  <div class="card" id="chartCard" style="display:none">
    <h2>7‑Day Trend</h2>
    <canvas id="trendChart"></canvas>
  </div>

  <div class="card" id="adminPanel" style="display:none">
    <h2>Admin – Rules</h2>
    <div class="row">
      <button onclick="loadRules()">Load rules</button>
      <button onclick="exportCSV()">Export rules CSV</button>
    </div>
    <div id="rules"></div>
    <h3>Update a rule</h3>
    <div class="row">
      <input id="f_feature" placeholder="feature (e.g., punycode)">
      <input id="f_weight" placeholder="weight (number)">
      <select id="f_enabled"><option>true</option><option>false</option></select>
      <button onclick="updateRule()">Save</button>
      <span id="ruleMsg" class="muted"></span>
    </div>
  </div>
</main>

<script>
// === CONFIG (replace these 2 lines) ===
const FIREBASE_CONFIG = { apiKey: "AIzaSyDKkDurWj7_1f4CzaVXuqP1ah3sC-j5Q7Q", authDomain: "phishguardian-ddaef.firebaseapp.com", projectId: "phishguardian-ddaef" };
const API_BASE = "https://script.google.com/macros/s/AKfycbzr9qqDngueDRJCCks6_T7q8Eb8x_Hl1hEw8FyqFa8ckz3x2N3AfkUaz1AtExsdhSOH/exec"; // ends with /exec

firebase.initializeApp(FIREBASE_CONFIG);
const auth = firebase.auth();
let DETS = []; // cached rows for filtering

auth.onAuthStateChanged(async (user) => {
  const el = document.getElementById('authStatus');
  if (user) {
    el.textContent = "Signed in as " + (user.email || user.uid);
    document.getElementById('role').textContent = "";
    showAdmin(false);
    // Check admin by calling /rules
    try {
      const idToken = await user.getIdToken();
      const r = await fetch(API_BASE + "?action=rules", { headers: { "Authorization": "Bearer " + idToken } });
      if (r.status === 200) {
        showAdmin(true);
        document.getElementById('role').textContent = "admin";
        document.getElementById('role').className='admin';
      }
    } catch (e) {}
    loadDetections();
  } else {
    el.textContent = "Signed out";
    showAdmin(false);
    renderDetections([]);
  }
});

function showAdmin(flag){ document.getElementById('adminPanel').style.display = flag ? "block":"none"; }

async function emailSignIn(){
  const em = prompt("Email:"); if (!em) return;
  const pw = prompt("Password:"); if (!pw) return;
  await auth.signInWithEmailAndPassword(em, pw).catch(err => alert(err.message));
}
async function googleSignIn(){
  await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(err => alert(err.message));
}
async function signOut(){ await auth.signOut(); }

function badge(v){ return `<span class="pill ${v}">${(v||'').toUpperCase()}</span>`; }
function esc(s){ return (s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

async function loadDetections(){
  const user = auth.currentUser;
  if (!user) return;
  const idToken = await user.getIdToken();
  const r = await fetch(API_BASE + "?action=detections", { headers: { "Authorization": "Bearer " + idToken } });
  const data = await r.json();
  DETS = data.rows || [];
  renderDetections(DETS);
  renderChart(DETS);
}

function applyFilters(){
  const v = document.getElementById('filterVerdict').value;
  const t = (document.getElementById('filterText').value||"").toLowerCase();
  let rows = DETS.slice();
  if (v) rows = rows.filter(r => (r.verdict||"").toLowerCase() === v);
  if (t) rows = rows.filter(r => (r.subject||"").toLowerCase().includes(t) || (r.from||"").toLowerCase().includes(t));
  renderDetections(rows);
}

function renderDetections(rows){
  document.getElementById('rowCount').textContent = rows.length + " rows";
  if (!rows.length){ document.getElementById('detections').innerHTML = "<p class='muted'>No data.</p>"; return; }
  const h = `
    <table><thead><tr>
      <th>When</th><th>From</th><th>Subject</th><th>Verdict</th><th>Risk</th><th>Reasons</th>
    </tr></thead><tbody>
    ${rows.slice().reverse().map(r=>`
      <tr>
        <td>${new Date(r.ts).toLocaleString()}</td>
        <td>${esc(r.from||"")}</td>
        <td>${esc(r.subject||"")}</td>
        <td>${badge((r.verdict||"benign").toLowerCase())}</td>
        <td>${r.risk||0}</td>
        <td>${esc(r.reasons||"")}</td>
      </tr>`).join("")}
    </tbody></table>`;
  document.getElementById('detections').innerHTML = h;
  document.getElementById('chartCard').style.display = rows.length ? "block":"none";
}

function renderChart(rows){
  const byDay = {};
  const now = new Date();
  for (let i=0;i<7;i++){
    const d = new Date(now - i*24*3600*1000);
    const key = new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10);
    byDay[key] = { benign:0, suspicious:0, phishing:0 };
  }
  rows.forEach(r=>{
    const d = new Date(r.ts);
    const key = new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10);
    if (!byDay[key]) return;
    const v = (r.verdict||"benign").toLowerCase();
    byDay[key][v] = (byDay[key][v]||0) + 1;
  });
  const labels = Object.keys(byDay).sort();
  const benign = labels.map(k=>byDay[k].benign);
  const suspicious = labels.map(k=>byDay[k].suspicious);
  const phishing = labels.map(k=>byDay[k].phishing);

  const ctx = document.getElementById('trendChart').getContext('2d');
  if (window._chart) window._chart.destroy();
  window._chart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [
      { label: 'Benign', data: benign },
      { label: 'Suspicious', data: suspicious },
      { label: 'Phishing', data: phishing }
    ]},
    options: { responsive:true, plugins:{ legend:{ position:'bottom' } } }
  });
}

async function loadRules(){
  const user = auth.currentUser; if (!user) return alert("Sign in first.");
  const idToken = await user.getIdToken();
  const r = await fetch(API_BASE + "?action=rules", { headers: { "Authorization": "Bearer " + idToken } });
  if (r.status !== 200){ document.getElementById('rules').innerHTML = "<p>Forbidden (not admin).</p>"; return; }
  const data = await r.json();
  const rules = data.rules || [];
  const h = `
    <table><thead><tr><th>Feature</th><th>Weight</th><th>Enabled</th></tr></thead><tbody>
      ${rules.map(x=>`<tr><td>${esc(x.feature)}</td><td>${x.weight}</td><td>${x.enabled}</td></tr>`).join("")}
    </tbody></table>`;
  document.getElementById('rules').innerHTML = h;
}

async function updateRule(){
  const user = auth.currentUser; if (!user) return alert("Sign in first.");
  const idToken = await user.getIdToken();
  const feature = document.getElementById('f_feature').value.trim();
  const weight = Number(document.getElementById('f_weight').value.trim());
  const enabled = document.getElementById('f_enabled').value.trim();
  if (!feature) return alert("Feature required");
  const r = await fetch(API_BASE, {
    method: "POST",
    headers: { "Authorization": "Bearer " + idToken, "Content-Type":"application/json" },
    body: JSON.stringify({ action:"updateRule", feature, weight, enabled })
  });
  const data = await r.json();
  document.getElementById('ruleMsg').textContent = r.status===200 ? "Saved." : ("Error: " + (data.error||r.status));
  if (r.status===200) loadRules();
}

</script>
</body>
</html>
